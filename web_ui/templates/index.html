<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IDS Dashboard</title>
    <link rel="stylesheet" href="/static/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="sidebar">
    <h2>FlowGuard monitor</h2>
    <ul>
        <li class="active"><a href="/">Dashboard</a></li>
        <li><a href="/logs">Logs</a></li>
    </ul>
</div>

<div class="main">
    <header>
        <h1> FlowGuard IDS</h1>
        <div class="header-controls">
            <button id="refreshBtn" onclick="loadRecentAlerts()">Refresh</button>
            <span id="lastUpdated"></span>
        </div>
    </header>
    <section class="graph">
        <h2>Live Traffic</h2>
        <div class="graph-container">
            <canvas id="trafficChart"></canvas>
        </div>
    </section>

    <section class="stats">
        <h2>Statistics</h2>
        <div class="stats-container">
            <div class="stat-card">
                <h3>Total Alerts</h3>
                <p id="totalAlerts">0</p>
            </div>
            <div class="stat-card">
                <h3>Recent Activity</h3>
                <p id="recentAlerts">0</p>
            </div>
            <div class="stat-card">
                <h3>Last Update</h3>
                <p id="lastUpdate">-</p>
            </div>
        </div>
    </section>

    <section class="alerts">
        <h2>Recent Alerts</h2>
        <div id="loadingSpinner" class="loading">Loading recent alerts...</div>
        <div id="errorMessage" class="error" style="display: none;"></div>
        <table>
            <thead>
            <tr>
                <th>Time</th>
                <th>Source IP</th>
                <th>Destination IP</th>
                <th>Type</th>
                <th>Confidence</th>
                <th>Message</th>
            </tr>
            </thead>
            <tbody id="alertsTableBody">
            <!-- JS will inject rows -->
            </tbody>
        </table>
    </section>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    // --- Socket.IO ---
    const socket = io();
    const recentTableBody = document.getElementById('alertsTableBody');
    const lastUpdated = document.getElementById("lastUpdated");
    const maxAlerts = 5;

    // Set pentru a preveni duplicatele
    const existingAlerts = new Set();

    // Funcție pentru adăugat alertă în tabel
    function addAlertRow(alert) {
        const alertKey = `${alert.timestamp}-${alert.source_ip}-${alert.destination_ip}`;
        if (existingAlerts.has(alertKey)) return; // previne duplicate
        existingAlerts.add(alertKey);

        // Conversie UTC → ora locală
        let localTime = "";
        if (alert.timestamp) {
            const d = new Date(alert.timestamp);
            localTime = d.toLocaleString("ro-RO", { timeZone: "Europe/Bucharest" });
        }

        const row = document.createElement("tr");
        row.innerHTML = `
        <td class="timestamp">${localTime}</td>
        <td class="ip-address">${alert.source_ip || ''}</td>
        <td class="ip-address">${alert.destination_ip || ''}</td>
        <td class="threat-type">${alert.alert_type || ''}</td>
        <td class="confidence">${alert.confidence || ''}</td>
        <td class="message">${alert.message || ''}</td>
    `;

        // Șterge placeholder "No recent alerts"
        if (recentTableBody.firstChild && recentTableBody.firstChild.textContent.includes("No recent alerts")) {
            recentTableBody.innerHTML = "";
        }

        recentTableBody.insertBefore(row, recentTableBody.firstChild);

        // Păstrează doar ultimele 5 alerte
        while (recentTableBody.children.length > maxAlerts) {
            const lastRow = recentTableBody.lastChild;
            const lastAlertKey = `${lastRow.querySelector('.timestamp').textContent}-${lastRow.querySelectorAll('.ip-address')[0].textContent}-${lastRow.querySelectorAll('.ip-address')[1].textContent}`;
            existingAlerts.delete(lastAlertKey);
            recentTableBody.removeChild(lastRow);
        }

        lastUpdated.textContent = `Last updated: ${new Date().toLocaleTimeString("ro-RO", { timeZone: "Europe/Bucharest" })}`;
    }

    // Ascultă alerte noi prin socket
    socket.on("new_alert", addAlertRow);

    // --- Load initial alerts ---
    async function loadRecentAlerts() {
        console.log(">>> loadRecentAlerts CALLED"); // DEBUG
        const loadingSpinner = document.getElementById('recentLoading');
        const errorMessage = document.getElementById('recentError');

        if (loadingSpinner) loadingSpinner.style.display = 'block';
        if (errorMessage) errorMessage.style.display = 'none';
        recentTableBody.innerHTML = '';

        try {
            console.log(">>> fetching /api/recent_alerts ...");
            const response = await fetch('/api/recent_alerts');
            console.log(">>> fetch DONE, status:", response.status);

            const result = await response.json();
            console.log(">>> /api/recent_alerts RESPONSE:", result);

            if (result.success && result.data.length > 0) {
                result.data.forEach(alert => addAlertRow(alert));
            } else {
                recentTableBody.innerHTML = '<tr><td colspan="6" class="no-data">No recent alerts</td></tr>';
            }
        } catch (e) {
            console.error('Error loading recent alerts:', e);
            if (errorMessage) {
                errorMessage.textContent = `Error loading recent alerts: ${e.message}`;
                errorMessage.style.display = 'block';
            }
        } finally {
            if (loadingSpinner) loadingSpinner.style.display = 'none';
        }
    }

    function formatLocalTime(utcString) {
        const date = new Date(utcString);
        return date.toLocaleString(); // sau .toLocaleTimeString() dacă vrei doar ora
    }

    // --- Stats ---
    async function updateStats() {
        try {
            const response = await fetch('/api/stats');
            const result = await response.json();
            if (!result.success) throw new Error(result.error);

            const stats = result.data;
            document.getElementById('totalAlerts').textContent = stats.total_alerts;
            document.getElementById('recentAlerts').textContent = stats.recent_alerts_count;

            if (stats.last_update) {
                // Convertește din UTC în local timezone (browser-ul utilizatorului)
                document.getElementById('lastUpdate').textContent = formatLocalTime(stats.last_update);

            } else {
                document.getElementById('lastUpdate').textContent = "N/A";
            }
        } catch (e) {
            console.error('Error updating stats:', e);
        }
    }


    // --- Traffic Chart ---
    let trafficChart;
    const maxDataPoints = 20;
    const trafficData = {
        labels: [],
        datasets: [{
            label: 'Packets/sec',
            data: [],
            borderColor: '#007bff',
            backgroundColor: 'rgba(0, 123, 255, 0.1)',
            tension: 0.4,
            fill: true
        }]
    };

    function initTrafficChart() {
        const ctx = document.getElementById('trafficChart').getContext('2d');
        trafficChart = new Chart(ctx, {
            type: 'line',
            data: trafficData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: 'Packets' } },
                    x: { title: { display: true, text: 'Time' } }
                },
                interaction: { mode: 'nearest', axis: 'x', intersect: false }
            }
        });
    }

    async function updateTrafficData() {
        try {
            const response = await fetch('/api/traffic');
            const result = await response.json();
            if (!result.success) throw new Error(result.error);

            const points = result.data;
            if (!points.length) return;

            trafficData.labels = [];
            trafficData.datasets[0].data = [];
            points.slice(-maxDataPoints).forEach(point => {
                trafficData.labels.push(new Date(point.timestamp).toLocaleTimeString());
                trafficData.datasets[0].data.push(point.packet_count);
            });

            trafficChart.update();
        } catch (e) {
            console.error('Error updating traffic data:', e);
        }
    }

    // --- Init ---
    document.addEventListener('DOMContentLoaded', function() {
        console.log(">>> DOMContentLoaded FIRED"); // DEBUG

        // Inițializări
        loadRecentAlerts();
        initTrafficChart();
        updateTrafficData();
        updateStats();

        // Refresh manual pentru alerts
        const refreshBtn = document.getElementById('refreshRecentBtn');
        if (refreshBtn) refreshBtn.addEventListener('click', loadRecentAlerts);

        // Interval pentru stats și trafic
        setInterval(updateTrafficData, 5000);
        setInterval(updateStats, 60000);
    });

</script>
</body>
</html>
