<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IDS Logs</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <div class="sidebar">
    <h2>IDS Monitor</h2>
    <ul>
      <li><a href="/">Dashboard</a></li>
      <li class="active"><a href="/logs">Logs</a></li>
    </ul>
  </div>

<div class="main">
  <header>
    <h1>Security Logs</h1>
    <div class="header-controls">
      <button id="refreshBtn" onclick="loadLogs()">Refresh</button>
      <select id="logsPerPage" onchange="changeLogsPerPage()">
        <option value="50">50 per page</option>
        <option value="100" selected>100 per page</option>
        <option value="200">200 per page</option>
      </select>
      <span id="lastUpdated"></span>
    </div>
  </header>

  <div class="log-stats">
    <div class="stat-card">
      <h3 id="totalLogs">0</h3>
      <p>Total Logs</p>
    </div>
    <div class="stat-card">
      <h3 id="currentPage">1</h3>
      <p>Current Page</p>
    </div>
    <div class="stat-card">
      <h3 id="totalPages">1</h3>
      <p>Total Pages</p>
    </div>
  </div>

  <section class="alerts">
    <h2>Security Log Entries</h2>
    <div id="loadingSpinner" class="loading">Loading logs from files...</div>
    <div id="errorMessage" class="error" style="display: none;"></div>

    <div class="table-container">
      <table id="logsTable" style="display: none;">
        <thead>
          <tr>
            <th>Time</th>
            <th>Source IP</th>
            <th>Destination IP</th>
            <th>Threat Type</th>
            <th>Protocol</th>
            <th>Packets</th>
            <th>Confidence</th>
            <th>Source File</th>
          </tr>
        </thead>
        <tbody id="logsTableBody">
          <!-- JavaScript will populate this -->
        </tbody>
      </table>
    </div>

    <!-- Pagination Controls -->
    <div id="paginationControls" class="pagination" style="display: none;">
      <button id="prevPage" onclick="changePage(-1)">← Previous</button>
      <span id="pageInfo">Page 1 of 1</span>
      <button id="nextPage" onclick="changePage(1)">Next →</button>
    </div>
  </section>
</div>

<script>
  let currentPage = 1;
  let logsPerPage = 100;
  let totalPages = 1;

  // Function to load logs from the backend
  async function loadLogs(page = 1) {
    const loadingSpinner = document.getElementById('loadingSpinner');
    const errorMessage = document.getElementById('errorMessage');
    const logsTable = document.getElementById('logsTable');
    const logsTableBody = document.getElementById('logsTableBody');
    const lastUpdated = document.getElementById('lastUpdated');
    const paginationControls = document.getElementById('paginationControls');

    // Show loading spinner
    loadingSpinner.style.display = 'block';
    errorMessage.style.display = 'none';
    logsTable.style.display = 'none';
    paginationControls.style.display = 'none';

    try {
      const response = await fetch(`/api/logs?page=${page}&limit=${logsPerPage}`);

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const result = await response.json();

      if (result.success) {
        displayLogs(result.data);
        updatePagination(result.pagination);
        updateStats(result.pagination);
        lastUpdated.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
      } else {
        throw new Error(result.error || 'Failed to fetch logs');
      }

    } catch (error) {
      console.error('Error loading logs:', error);
      errorMessage.textContent = `Error loading logs: ${error.message}`;
      errorMessage.style.display = 'block';
    } finally {
      loadingSpinner.style.display = 'none';
    }
  }

  // Function to display logs in the table
  function displayLogs(logs) {
    const logsTableBody = document.getElementById('logsTableBody');
    const logsTable = document.getElementById('logsTable');

    // Clear existing rows
    logsTableBody.innerHTML = '';

    if (logs.length === 0) {
      logsTableBody.innerHTML = '<tr><td colspan="8" class="no-data">No logs found</td></tr>';
    } else {
      // Add each log as a table row
      logs.forEach(log => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
          <td class="timestamp">${log.timestamp}</td>
          <td class="ip-address">${log.source_ip}:${log.source_port}</td>
          <td class="ip-address">${log.destination_ip}:${log.destination_port}</td>
          <td class="threat-type">${log.threat_type}</td>
          <td class="protocol">${log.protocol}</td>
          <td class="packets">${log.packets}</td>
          <td class="confidence">${log.confidence}</td>
          <td class="source-file">${log.file_source}</td>
        `;

        logsTableBody.appendChild(row);
      });
    }

    // Show the table
    logsTable.style.display = 'table';
  }

  // Function to update pagination info
  function updatePagination(pagination) {
    const paginationControls = document.getElementById('paginationControls');
    const pageInfo = document.getElementById('pageInfo');
    const prevPage = document.getElementById('prevPage');
    const nextPage = document.getElementById('nextPage');

    currentPage = pagination.current_page;
    totalPages = pagination.total_pages;

    pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;

    // Enable/disable pagination buttons
    prevPage.disabled = currentPage <= 1;
    nextPage.disabled = currentPage >= totalPages;

    // Show pagination if there are multiple pages
    if (totalPages > 1) {
      paginationControls.style.display = 'flex';
    }
  }

  // Function to update statistics
  function updateStats(pagination) {
    document.getElementById('totalLogs').textContent = pagination.total_logs;
    document.getElementById('currentPage').textContent = pagination.current_page;
    document.getElementById('totalPages').textContent = pagination.total_pages;
  }

  // Function to change page
  function changePage(direction) {
    const newPage = currentPage + direction;
    if (newPage >= 1 && newPage <= totalPages) {
      loadLogs(newPage);
    }
  }

  // Function to change logs per page
  function changeLogsPerPage() {
    const select = document.getElementById('logsPerPage');
    logsPerPage = parseInt(select.value);
    currentPage = 1;
    loadLogs(1);
  }

  // Load logs when page loads
  document.addEventListener('DOMContentLoaded', function() {
    loadLogs();

    // Auto-refresh every 60 seconds
    setInterval(() => loadLogs(currentPage), 60000);
  });

  // Manual refresh button
  document.getElementById('refreshBtn').addEventListener('click', () => loadLogs(currentPage));
</script>
</body>
</html>