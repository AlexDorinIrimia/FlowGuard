<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IDS Logs</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <div class="sidebar">
    <h2>IDS Monitor</h2>
    <ul>
      <li><a href="/">Dashboard</a></li>
      <li class="active"><a href="/logs">Logs</a></li>
    </ul>
  </div>

<div class="main">
  <header>
    <h1>Security Logs</h1>
    <div class="header-controls">
      <button id="refreshBtn" onclick="loadLogs()">Refresh</button>
      <select id="logsPerPage" onchange="changeLogsPerPage()">
        <option value="50">50 per page</option>
        <option value="100" selected>100 per page</option>
        <option value="200">200 per page</option>
      </select>
      <span id="lastUpdated"></span>
    </div>
  </header>

  <div class="log-stats">
    <div class="stat-card">
      <h3 id="totalLogs">0</h3>
      <p>Total Logs</p>
    </div>
    <div class="stat-card">
      <h3 id="currentPage">1</h3>
      <p>Current Page</p>
    </div>
    <div class="stat-card">
      <h3 id="totalPages">1</h3>
      <p>Total Pages</p>
    </div>
  </div>

  <section class="alerts">
    <h2>Security Log Entries</h2>
    <div id="loadingSpinner" class="loading">Loading logs from files...</div>
    <div id="errorMessage" class="error" style="display: none;"></div>

    <div class="table-container">
      <table id="logsTable" style="display: none;">
        <thead>
          <tr>
            <th>Time</th>
            <th>Source IP</th>
            <th>Destination IP</th>
            <th>Type</th>
            <th>Confidence</th>
            <th>Message</th>
          </tr>
        </thead>
        <tbody id="logsTableBody">
          <!-- JavaScript will populate this -->
        </tbody>
      </table>
    </div>

    <!-- Pagination Controls -->
    <div id="paginationControls" class="pagination" style="display: none;">
      <button id="prevPage" onclick="changePage(-1)">← Previous</button>
      <span id="pageInfo">Page 1 of 1</span>
      <button id="nextPage" onclick="changePage(1)">Next →</button>
    </div>
  </section>
</div>

<script>
  let currentPage = 1;
  let logsPerPage = 100;
  let totalPages = 1;

  function formatLocalTime(utcString) {
    if (!utcString) return "";
    const date = new Date(utcString);
    return date.toLocaleString("ro-RO", {
      timeZone: "Europe/Bucharest",
      hour12: false
    });
  }

  async function loadLogs(page = 1) {
    const loadingSpinner = document.getElementById('loadingSpinner');
    const errorMessage = document.getElementById('errorMessage');
    const logsTable = document.getElementById('logsTable');
    const logsTableBody = document.getElementById('logsTableBody');
    const lastUpdated = document.getElementById('lastUpdated');
    const paginationControls = document.getElementById('paginationControls');

    loadingSpinner.style.display = 'block';
    errorMessage.style.display = 'none';
    logsTable.style.display = 'none';
    paginationControls.style.display = 'none';

    try {
      const response = await fetch(`/api/logs?page=${page}&limit=${logsPerPage}`);
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

      const result = await response.json();
      console.log("Fetched result:", result);  // DEBUG

      if (result.success && Array.isArray(result.data)) {
        displayLogs(result.data);
        updatePagination(result.pagination);
        lastUpdated.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
      } else {
        throw new Error(result.error || 'Failed to fetch alerts or data not array');
      }

    } catch (error) {
      console.error('Error loading logs:', error);
      errorMessage.textContent = `Error loading alerts: ${error.message}`;
      errorMessage.style.display = 'block';
    } finally {
      loadingSpinner.style.display = 'none';
    }
  }

  function displayLogs(alerts) {
    const logsTableBody = document.getElementById('logsTableBody');
    const logsTable = document.getElementById('logsTable');

    logsTableBody.innerHTML = '';

    if (!alerts || alerts.length === 0) {
      logsTableBody.innerHTML = '<tr><td colspan="6" class="no-data">No alerts found</td></tr>';
    } else {
      alerts.forEach(alert => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="timestamp">${formatLocalTime(alert.timestamp) || ''}</td>
            <td class="ip-address">${alert.source_ip || ''}</td>
            <td class="ip-address">${alert.destination_ip || ''}</td>
            <td class="threat-type">${alert.alert_type || ''}</td>
            <td class="confidence">${alert.confidence || ''}</td>
            <td class="message">${alert.message || ''}</td>
        `;
        logsTableBody.appendChild(row);
      });
    }

    logsTable.style.display = 'table';
  }

    function updatePagination(pagination) {
  const paginationControls = document.getElementById('paginationControls');
  const pageInfo = document.getElementById('pageInfo');
  const prevPage = document.getElementById('prevPage');
  const nextPage = document.getElementById('nextPage');

  currentPage = pagination.current_page;
  totalPages = pagination.total_pages;

  // update statistic cards
  document.getElementById('totalLogs').textContent = pagination.total_alerts || 0;
  document.getElementById('currentPage').textContent = currentPage;
  document.getElementById('totalPages').textContent = totalPages;

  pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
  prevPage.disabled = currentPage <= 1;
  nextPage.disabled = currentPage >= totalPages;

  paginationControls.style.display = totalPages > 1 ? 'flex' : 'none';
}

  function changePage(direction) {
    const newPage = currentPage + direction;
    if (newPage >= 1 && newPage <= totalPages) loadLogs(newPage);
  }

  function changeLogsPerPage() {
    const select = document.getElementById('logsPerPage');
    logsPerPage = parseInt(select.value);
    currentPage = 1;
    loadLogs(1);
  }

  // load initial logs
  loadLogs();
</script>
</body>
</html>

